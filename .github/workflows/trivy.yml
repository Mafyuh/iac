name: Trivy Vulnerability Scan
on:
  pull_request:
    paths:
      - "docker/**"
      - "kubernetes/**"
  workflow_dispatch:
    inputs:
      image:
        description: "Container image to scan (e.g., nginx:latest)"
        required: true
        type: string

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  trivy-scan:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get Changed Files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@1a5aeab1bfa64d0c4e786f501d5a3f1fad4a24da # v0.4.1
        with:
          patterns: |
            kubernetes/**/*
            docker/**/*

      - name: Detect image from diff or manual input
        id: images
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "image=${{ inputs.image }}" >> $GITHUB_OUTPUT
            echo "should_scan=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          image=$(git diff -U0 HEAD^ HEAD \
            | grep -E "^\+.*(image:|repository:|tag:)" \
            | awk '
              /repository:/ { repo=$2 }
              /tag:/ { tag=$2 }
              /image:/ { img=$2 }
              END {
                gsub(/["'\'' ]/,"",repo); gsub(/["'\'' ]/,"",tag)
                gsub(/["'\'' ]/,"",img)
                if (repo && tag) print repo ":" tag;
                else if (img) print img;
              }'
          )

          echo "image=$image" >> $GITHUB_OUTPUT
          echo "should_scan=$([ -n "$image" ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Scan changed image with Trivy
        if: steps.images.outputs.should_scan == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.images.outputs.image }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          scanners: "vuln"

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.images.outputs.should_scan == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

      - name: Comment PR with link to security scan
        if: steps.images.outputs.should_scan == 'true' && steps.images.outputs.is_manual != 'true'
        uses: mshick/add-pr-comment@v2
        with:
          message-id: trivy-scan-${{ github.event.pull_request.number }}
          message: |
            ## üõ°Ô∏è Trivy Security Scan Complete

            **Scanned Image:** `${{ steps.images.outputs.image }}`
            üìä **[View Security Scan Results](https://github.com/${{ github.repository }}/security/code-scanning?query=pr%3A${{ github.event.pull_request.number }}+tool%3ATrivy+is%3Aopen)**

            _Results are available in the Security tab above._
