name: Trivy Vulnerability Scan
on:
  pull_request:
    paths:
      - "docker/**"
      - "kubernetes/**"
  workflow_dispatch:
    inputs:
      image:
        description: "Container image to scan (e.g., nginx:latest)"
        required: true
        type: string

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  trivy-scan:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract changed images from PR diff
        id: images
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "image=${{ inputs.image }}" >> $GITHUB_OUTPUT
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "=== Detecting container images from PR ==="

          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"

          diff=$(git diff -U0 "$base" "$head")

          repo=$(echo "$diff" | grep -E '^\+.*repository:' | awk '{print $2}' | head -n1)
          tag=$(echo "$diff" | grep -E '^\+.*tag:' | awk '{print $2}' | head -n1)

          if [ -n "$repo" ] && [ -n "$tag" ]; then
            image="$repo:$tag"
          else
            image=$(echo "$diff" | grep -E '^\+.*image:' | sed -E 's/.*image:[[:space:]]*([^[:space:]#]+).*/\1/' | head -n1)
          fi

          echo "image=$image" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT

          if [ -n "$image" ]; then
            echo "should_scan=true" >> $GITHUB_OUTPUT
          else
            echo "should_scan=false" >> $GITHUB_OUTPUT
          fi

      - name: Scan changed image with Trivy
        if: steps.images.outputs.should_scan == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.images.outputs.image }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          scanners: "vuln"

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.images.outputs.should_scan == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

      - name: Comment PR with link to security scan
        if: steps.images.outputs.should_scan == 'true' && steps.images.outputs.is_manual != 'true'
        uses: mshick/add-pr-comment@v2
        with:
          message-id: trivy-scan-${{ github.event.pull_request.number }}
          message: |
            ## üõ°Ô∏è Trivy Security Scan Complete

            **Scanned Image:** `${{ steps.images.outputs.image }}`
            üìä **[View Security Scan Results](https://github.com/${{ github.repository }}/security/code-scanning?query=pr%3A${{ github.event.pull_request.number }}+tool%3ATrivy+is%3Aopen)**

            _Results are available in the Security tab above._
