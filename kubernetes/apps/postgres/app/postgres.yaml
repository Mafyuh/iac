apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: pg-cluster
  namespace: databases
spec:
  teamId: "mafyuh"
  allowedSourceRanges:
    - 0.0.0.0/0
  serviceAnnotations:
    lbipam.cilium.io/ips: "10.0.0.210"
  volume:
    size: 10Gi
    storageClass: ceph-block
  numberOfInstances: 3
  enableMasterLoadBalancer: true
  enableLogicalBackup: true
  users:
    mafyuh:
      - superuser
      - createdb
    authentik: []
    blocky: []
    gatus: []
    jellyseerr: []
    netbox: []
    umami: []
  databases:
    authentik: authentik
    blocky: blocky
    gatus: gatus
    jellyseerr: jellyseerr
    netbox: netbox
    umami: umami
  postgresql:
    version: "17"
  patroni:
    pg_hba:
      - "local all all trust"
      - "hostssl all +zalandos 127.0.0.1/32 pam"
      - "host all all 127.0.0.1/32 md5"
      - "hostssl all +zalandos ::1/128 pam"
      - "host all all ::1/128 md5"
      - "local replication standby trust"
      - "hostssl replication standby all md5"
      - "host all all 10.244.0.0/16 md5"
      - "hostnossl all all all reject"
      - "hostssl all +zalandos all pam"
      - "hostssl all all all md5"
  resources:
    requests:
      cpu: 10m
      memory: 115Mi
    limits:
      cpu: 250m
      memory: 256Mi
  sidecars:
    - name: exporter
      image: quay.io/prometheuscommunity/postgres-exporter:v0.18.1
      ports:
        - name: metrics
          containerPort: 9187
          protocol: TCP
      env:
        - name: DATA_SOURCE_URI
          value: "pg-cluster:5432/postgres?sslmode=disable"
        - name: DATA_SOURCE_USER
          value: "mafyuh"
        - name: DATA_SOURCE_PASS
          valueFrom:
            secretKeyRef:
              name: postgres-secrets
              key: MAFYUH_POSTGRES_PASSWORD
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          cpu: 100m
          memory: 64Mi
